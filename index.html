<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Data Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@700&family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Define Accent Colors and Base Styles */
        :root {
            --primary-purple: #667eea;
            --secondary-purple: #764ba2;
            --accent-green: #10b981; /* Vibrant Green Accent for action */
            --bg-gradient: linear-gradient(135deg, var(--primary-purple) 0%, var(--secondary-purple) 100%);
            --card-bg: #ffffff;
            --card-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            /* Applied Plus Jakarta Sans for body/default text (FontBody suggestion) */
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 40px 20px;
            color: #374151;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
            padding-top: 20px;
        }

        .header h1 {
            /* Applied Space Grotesk for the main heading (MoodHeading/StartupSpace suggestion) */
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Search Card */
        .search-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 32px;
        }

        .search-form {
            display: flex;
            gap: 16px;
            max-width: 700px;
            margin: 0 auto;
            position: relative;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: all 0.3s;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Autocomplete Styles (Retained) */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            display: none;
        }
        .autocomplete-dropdown.active { display: block; }
        .autocomplete-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f3f4f6;
        }
        .autocomplete-item:hover, .autocomplete-item.selected { background: #f9fafb; }
        .autocomplete-item .ticker-symbol { font-weight: 700; color: var(--primary-purple); }
        .autocomplete-item .company-name { color: #6b7280; font-size: 0.875rem; margin-top: 2px; }


        /* Get Data Button - ACCENT COLOR USED */
        .search-btn {
            padding: 16px 30px;
            background: var(--accent-green);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4);
        }

        .search-btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Current Ticker Display */
        .ticker-display {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            padding: 10px 0;
            color: white;
            font-size: 1.1rem;
        }

        .ticker-symbol-main {
            font-size: 1.8rem;
            font-weight: 700;
            margin-right: 15px;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
        }

        .ticker-name-main {
            font-size: 1.1rem;
            opacity: 0.8;
        }

        /* Data Grid for Cards (Now a simple vertical stack) */
        .data-grid {
            display: grid;
            gap: 24px;
            /* Changed to a single column to enforce separation into exclusive rows */
            grid-template-columns: 1fr;
        }

        .data-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
        }

        .data-card:hover {
            box-shadow: var(--card-shadow);
            transform: translateY(-2px);
        }

        /* All cards will effectively use this, forcing them onto their own rows */
        .full-width {
             grid-column: 1 / -1;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 20px 24px;
            background: #fcfcfc;
            border-bottom: 1px solid #f3f4f6;
            user-select: none;
            transition: background 0.2s;
        }

        .card-header:hover {
            background: #f5f5f5;
        }

        .card-header h2 {
            font-size: 1.25rem;
            color: var(--primary-purple);
            margin: 0;
            display: flex;
            align-items: center;
        }

        .card-header h2 span {
            margin-right: 10px;
            font-size: 1.5rem;
            line-height: 1;
        }

        .dropdown-icon {
            font-size: 1.5rem;
            color: var(--primary-purple);
            transition: transform 0.3s ease;
        }

        .dropdown-icon.collapsed {
            transform: rotate(0deg);
        }

        .dropdown-icon:not(.collapsed) {
             transform: rotate(180deg);
        }

        .card-content {
            padding: 0 24px;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            /* Increased transition time for a smoother dropdown feel */
            transition: max-height 0.6s ease-in-out, opacity 0.4s ease;
        }

        .card-content:not(.collapsed) {
            max-height: 2000px; /* Sufficiently large for expansion */
            opacity: 1;
            padding: 20px 24px;
        }

        /* Tables */
        .table-scroll-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .data-table table {
            min-width: 600px;
            border-collapse: collapse;
            width: 100%;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }

        .data-table th {
            font-weight: 600;
            background: #f9fafb;
            color: var(--primary-purple);
        }

        .data-table tr:nth-child(even) {
            background-color: #fcfcfc;
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* RSI Display */
        .rsi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            padding-top: 10px;
        }

        .rsi-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            background-color: #f9fafb;
        }

        .rsi-item strong {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .rsi-item .rsi-value {
            padding: 4px 8px;
            background: #eef2ff;
            color: #4f46e5;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* MACD Histogram Styles */
        .data-table td.positive-hist { color: var(--accent-green); font-weight: 600; }
        .data-table td.negative-hist { color: #ef4444; font-weight: 600; }

        /* AI Review Section Styling */
        .ai-review-content {
            color: #374151;
            line-height: 1.7;
            font-size: 1rem;
        }
        .ai-review-content h3 {
            color: var(--secondary-purple);
            font-size: 1.3rem;
            margin-bottom: 10px;
        }
        .ai-review-content strong {
            font-weight: 700;
        }
        .ai-review-content strong.sentiment-bullish {
            color: var(--accent-green);
        }
        .ai-review-content strong.sentiment-bearish {
             color: #ef4444;
        }
        .ai-review-content p {
            margin-bottom: 15px;
        }

        /* Loading/Error State */
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            border-left: 4px solid #dc2626;
            display: none;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            body { padding: 20px 10px; }
            .header h1 { font-size: 2.2rem; }
            .search-form { flex-direction: column; }
            .search-btn { width: 100%; }
            /* Not needed anymore as all cards are full-width by default */
            .ticker-display { flex-direction: column; text-align: center;}
            .ticker-symbol-main { margin-right: 0; margin-bottom: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Stock Data Dashboard</h1>
            <p>Real-time stock analysis with technical indicators</p>
        </div>

        <div class="search-card">
            <form class="search-form" onsubmit="fetchData(event)">
                <div class="input-wrapper">
                    <input
                        type="text"
                        id="symbol"
                        class="search-input"
                        placeholder="Enter Stock Ticker (e.g., AAPL, ITBEES.NS)"
                        autocomplete="off"
                        required
                    >
                    <div id="autocomplete" class="autocomplete-dropdown"></div>
                </div>
                <button type="submit" class="search-btn" id="searchBtn">
                    Get Data
                </button>
            </form>
        </div>

        <div id="loading" style="display:none;" class="loading">
            <div class="spinner"></div>
            <div>Fetching stock data...</div>
        </div>

        <div id="error" class="error"></div>

        <div id="output">
            </div>
    </div>

    <script>
        // --- Autocomplete Data and Logic (Simplified for brevity) ---
        const stockDatabase = [
            { symbol: 'AAPL', name: 'Apple Inc.' },
            { symbol: 'MSFT', name: 'Microsoft Corporation' },
            { symbol: 'GOOGL', name: 'Alphabet Inc. (Google)' },
            { symbol: 'TSLA', name: 'Tesla Inc.' },
            { symbol: 'ITBEES.NS', name: 'Nippon India Nifty IT ETF' },
            { symbol: 'NIFTYBEES.NS', name: 'Nippon India Nifty 50 BeES' },
            { symbol: 'UTINIFTETF.NS', name: 'UTI Nifty 50 ETF' },
            { symbol: 'UTISENSETF.NS', name: 'UTI BSE Sensex ETF' },
            { symbol: 'BANKNIFTY1.NS', name: 'Kotak Nifty Bank ETF' },
            { symbol: 'UTIBANKETF.NS', name: 'UTI Nifty Bank ETF' },
            { symbol: 'NIFTY1.NS', name: 'Kotak Nifty 50 ETF' },
            { symbol: 'GOLDSHARE.NS', name: 'UTI Gold ETF' },
            { symbol: 'UTINEXT50.NS', name: 'UTI-Nifty Next 50 ETF' },
            { symbol: 'PSUBANK.NS', name: 'Kotak Nifty PSU Bank ETF' },
            { symbol: 'ALPHA.NS', name: 'Kotak Nifty Alpha 50 ETF' },
            { symbol: 'SILVERETF.NS', name: 'UTI Silver ETF' },
            { symbol: 'IT.NS', name: 'Kotak Nifty IT ETF' },
            { symbol: 'LOWVOL1.NS', name: 'Kotak Nifty 100 Low Volatility 30 ETF' },
            { symbol: 'NV20.NS', name: 'Kotak Nifty 50 value 20 ETF' },
            { symbol: 'MIDCAP.NS', name: 'Kotak Nifty Midcap 50 ETF' },
            { symbol: 'UTISXN50.NS', name: 'UTI BSE Sensex Next 50 ETF' },
            { symbol: 'NIF5GETF.NS', name: 'UTI Nifty 5 Yr Benchmark G-Sec ETF' },
            { symbol: 'SENSEX1.NS', name: 'Kotak S&P BSE Sensex ETF' },
            { symbol: 'NIF10GETF.NS', name: 'UTI Nifty 10 yr Benchmark G-Sec ETF' },
            { symbol: 'NIFMID150.NS', name: 'UTI Nifty Midcap 150 ETF' },
            { symbol: 'NIFITETF.NS', name: 'UTI Nifty IT ETF' },
            { symbol: 'LIQUID1.NS', name: 'Kotak Nifty 1D Rate Liquid ETF' },
            { symbol: 'MNC.NS', name: 'Kotak Nifty MNC ETF' },
            { symbol: 'CONS.NS', name: 'Kotak Nifty India Consumption ETF' },
            { symbol: 'HDFCGOLD.NS', name: 'HDFC Gold ETF' },
            { symbol: 'TATSILV.NS', name: 'Tata Silver ETF' },
            { symbol: 'GSEC10IETF.NS', name: 'ICICI Prudential Nifty 10 yr Benchmark G-Sec ETF' },
            { symbol: 'MIDSMALL.NS', name: 'Mirae Asset Nifty MidSmallcap400 Momentum Quality 100 ETF' },
            { symbol: 'ABSLLIQUID.NS', name: 'Aditya Birla Sun Life CRISIL Liquid Overnight ETF' },
            { symbol: 'HEALTHADD.NS', name: 'DSP Nifty Healthcare ETF' },
            { symbol: 'MAFANG.NS', name: 'Mirae Asset NYSE FANG+ ETF' },
            { symbol: 'BBNPPGOLD.NS', name: 'Baroda BNP Paribas Gold ETF' },
            { symbol: 'GSEC10YEAR.NS', name: 'Mirae Asset Nifty 8-13 Yr G-Sec ETF' },
            { symbol: 'LTGILTBEES.NS', name: 'Reliance ETF Long Term Gilt' },
            { symbol: 'LIQUIDCASE.NS', name: 'Zerodha Nifty 1D Rate Liquid ETF' },
            { symbol: 'MOGSEC.NS', name: 'MOTILAL OSWAL 5 YEAR G-SEC ETF' },
            { symbol: 'ESILVER.NS', name: 'Edelweiss Silver ETF' },
            { symbol: 'BANKBETF.NS', name: 'Bajaj Finserv Nifty Bank ETF' },
            { symbol: 'NIFTYBETF.NS', name: 'Bajaj Finserv Nifty 50 ETF' },
            { symbol: 'GROWWPOWER.NS', name: 'Groww BSE Power ETF' },
            { symbol: 'LICNETFN50.NS', name: 'LIC MF Nifty 50 ETF' },
            { symbol: 'ECAPINSURE.NS', name: 'Edelweiss BSE Capital Markets & Insurance ETF' },
            { symbol: 'ITBEES.NS', name: 'Nippon India ETF Nifty IT' },
            { symbol: 'MIDQ50ADD.NS', name: 'DSP Nifty Midcap 150 Quality 50 ETF' },
            { symbol: 'GSEC5IETF.NS', name: 'ICICI Prudential Nifty 5 yr Benchmark G-SEC ETF' },
            { symbol: 'EBBETF0433.NS', name: 'Bharat Bond ETF - April 2033' },
            { symbol: 'BSLNIFTY.NS', name: 'Aditya Birla Sun Life Nifty 50 ETF' },
            { symbol: 'BSLGOLDETF.NS', name: 'Aditya Birla Sun Life Gold ETF' },
            { symbol: 'BANKETF.NS', name: 'Mirae Asset Nifty Bank ETF' },
            { symbol: 'EBBETF0431.NS', name: 'BHARAT Bond ETF April 2031' },
            { symbol: 'EVINDIA.NS', name: 'Mirae Asset Nifty EV and New Age Automotive ETF' },
            { symbol: 'ABGSEC.NS', name: 'Aditya Birla Sun Life CRISIL Broad Based Gilt ETF' },
            { symbol: 'LIQUIDADD.NS', name: 'DSP BSE Liquid Rate ETF' },
            { symbol: 'ITIETF.NS', name: 'ICICI Prudential Nifty IT ETF' },
            { symbol: 'METALFUND.NS', name: 'Mirae Asset Nifty Metal ETF' },
            { symbol: 'BANKBEES.NS', name: 'Nippon India ETF Nifty Bank BeES' },
            { symbol: 'SHARIABEES.NS', name: 'Nippon India ETF Nifty 50 Shariah BeES' },
            { symbol: 'NIFTYQLITY.NS', name: 'Aditya Birla Sun Life Nifty 200 Quality 30 ETF' },
            { symbol: 'SILVERBEES.NS', name: 'Nippon India Silver ETF' },
            { symbol: 'GOLD1.NS', name: 'Kotak Gold ETF' },
            { symbol: 'ABSLBANETF.NS', name: 'Aditya Birla Sun Life Nifty Bank ETF' },
            { symbol: 'HDFCSILVER.NS', name: 'HDFC Silver ETF' },
            { symbol: 'SILVER360.NS', name: '360 ONE Silver ETF' },
            { symbol: 'HDFCSML250.NS', name: 'HDFC Nifty Smallcap 250 ETF' },
            { symbol: 'INFRAIETF.NS', name: 'ICICI Prudential Nifty Infrastructure ETF' },
            { symbol: 'IDFSENSEXE.NS', name: 'IDFC Sensex ETF' },
            { symbol: 'HDFCNIFIT.NS', name: 'HDFC Nifty IT ETF' },
            { symbol: 'LIQUID.NS', name: 'Mirae Asset Nifty 1D Rate Liquid ETF' },
            { symbol: 'SBINEQWETF.NS', name: 'SBI Nifty50 Equal Weight ETF' },
            { symbol: 'NIFTYBEES.NS', name: 'Nippon India ETF Nifty 50 BeES' },
            { symbol: 'EVIETF.NS', name: 'ICICI Prudential Nifty EV & New Age Automotive ETF' },
            { symbol: 'CONSUMIETF.NS', name: 'ICICI Prudential Nifty India Consumption ETF' },
            { symbol: 'SELECTIPO.NS', name: 'Mirae Asset BSE Select IPO ETF' },
            { symbol: 'AXISHCETF.NS', name: 'Axis NIFTY Healthcare ETF' },
            { symbol: 'SENSEXBEES.NS', name: 'Reliance ETF Sensex' },
            { symbol: 'PSUBNKIETF.NS', name: 'ICICI Prudential Nifty PSU Bank ETF' },
            { symbol: 'LICNETFSEN.NS', name: 'LIC MF Sensex ETF' },
            { symbol: 'MID150CASE.NS', name: 'Zerodha Nifty Midcap 150 ETF' },
            { symbol: 'IVZINGOLD.NS', name: 'Invesco India Gold ETF' },
            { symbol: 'GOLDCASE.NS', name: 'Zerodha Gold ETF' },
            { symbol: 'LIQUIDSBI.NS', name: 'SBI NIFTY 1D Rate ETF' },
            { symbol: 'GSEC10ABSL.NS', name: 'Aditya Birla Sun Life Crisil 10 Year Gilt ETF' },
            { symbol: 'LIQUIDSHRI.NS', name: 'Shriram Nifty 1D Rate Liquid ETF' },
            { symbol: 'AXISCETF.NS', name: 'Axis NIFTY India Consumption ETF' },
            { symbol: 'INTERNET.NS', name: 'Mirae Asset Nifty India Internet ETF' },
            { symbol: 'TOP100CASE.NS', name: 'Zerodha Nifty 100 ETF' },
            { symbol: 'LTGILTCASE.NS', name: 'Zerodha Nifty 8-13 Yr G-Sec ETF' },
            { symbol: 'NIFTYIETF.NS', name: 'ICICI Prudential Nifty 50 ETF' },
            { symbol: 'HDFCQUAL.NS', name: 'HDFC NIFTY 100 Quality 30 ETF' },
            { symbol: 'CASHIETF.NS', name: 'ICICI Prudential BSE Liquid Rate ETF' },
            { symbol: 'BBETF0432.NS', name: 'BHARAT Bond ETF - April 2032' },
            { symbol: 'SBILIQETF.NS', name: 'SBI NIFTY 1D Rate Liquid ETF' },
            { symbol: 'LIQUIDETF.NS', name: 'DSP NIFTY 1D Rate Liquid ETF' },
            { symbol: 'MID150BEES.NS', name: 'Nippon India ETF Nifty Midcap 150' },
            { symbol: 'LIQUIDPLUS.NS', name: 'Mirae Asset Nifty 1D Rate Liquid ETF' },
            { symbol: 'HDFCPSUBK.NS', name: 'HDFC Nifty PSU Bank ETF' },
            { symbol: 'MAKEINDIA.NS', name: 'Mirae Asset Nifty India Manufacturing ETF' },
            { symbol: 'PHARMABEES.NS', name: 'Nippon India Nifty Pharma ETF' },
            { symbol: 'MOMOMENTUM.NS', name: 'Motilal Oswal Nifty 200 Momentum 30 ETF' },
            { symbol: 'BSLSENETFG.NS', name: 'Aditya Birla Sun Life BSE Sensex ETF' },
            { symbol: 'NIFTY50ADD.NS', name: 'DSP Nifty 50 ETF' },
            { symbol: 'HDFCPVTBAN.NS', name: 'HDFC Nifty Private Bank ETF' },
            { symbol: 'HDFCNIFBAN.NS', name: 'HDFC Nifty Banking ETF' },
            { symbol: 'SML100CASE.NS', name: 'Zerodha Nifty Smallcap 100 ETF' },
            { symbol: 'MANUFGBEES.NS', name: 'Nippon India Nifty India Manufacturing ETF' },
            { symbol: 'EQUAL200.NS', name: 'Mirae Asset BSE 200 Equal Weight ETF' },
            { symbol: 'SILVERIETF.NS', name: 'ICICI Prudential Silver ETF' },
            { symbol: 'ALPL30IETF.NS', name: 'ICICI Prudential Nifty Alpha Low-Volatility 30 ETF' },
            { symbol: 'BANKPSU.NS', name: 'Mirae Asset Nifty PSU Bank ETF' },
            { symbol: 'SENSEXADD.NS', name: 'DSP BSE Sensex ETF' },
            { symbol: 'HDFCMOMENT.NS', name: 'HDFC Nifty 200 Momentum 30 ETF' },
            { symbol: 'BANKETFADD.NS', name: 'DSP Nifty Bank ETF' },
            { symbol: 'CPSEETF.NS', name: 'CPSE ETF' },
            { symbol: 'PVTBANKADD.NS', name: 'DSP Nifty Private Bank ETF' },
            { symbol: 'QUAL30IETF.NS', name: 'ICICI Prudential Nifty 200 Quality 30 ETF' },
            { symbol: 'NEXT50IETF.NS', name: 'ICICI Prudential Nifty Next 50 ETF' },
            { symbol: 'SBISENSEX.NS', name: 'SBI ETF SENSEX' },
            { symbol: 'SILVERCASE.NS', name: 'Zerodha Silver ETF' },
            { symbol: 'ABSLNN50ET.NS', name: 'Aditya Birla Sun Life Nifty Next 50 ETF' },
            { symbol: 'AXISTECETF.NS', name: 'Axis NIFTY IT ETF' },
            { symbol: 'ALPHAETF.NS', name: 'Mirae Asset Nifty 200 Alpha 30 ETF' },
            { symbol: 'QNIFTY.NS', name: 'Quantum Nifty 50 ETF' },
            { symbol: 'SETFGOLD.NS', name: 'SBI Gold ETF' },
            { symbol: 'OILIETF.NS', name: 'ICICI Prudential Nifty Oil & Gas ETF' },
            { symbol: 'MOMENTUM.NS', name: 'Aditya Birla Sun Life Nifty 200 Momentum 30 ETF' },
            { symbol: 'LICNMID100.NS', name: 'LIC MF Nifty Midcap 100 ETF' },
            { symbol: 'SETFNIF50.NS', name: 'SBI ETF Nifty 50' },
            { symbol: 'FINIETF.NS', name: 'ICICI Prudential Nifty Financial Services Ex-Bank ETF' },
            { symbol: 'SBISILVER.NS', name: 'SBI Silver ETF' },
            { symbol: 'AXISGOLD.NS', name: 'Axis Gold ETF' },
            { symbol: 'UNIONGOLD.NS', name: 'Union Gold ETF' },
            { symbol: 'HDFCNIF100.NS', name: 'HDFC Nifty 100 ETF' },
            { symbol: 'LIQUIDBEES.NS', name: 'Nippon India ETF Nifty 1D Rate Liquid BeES' },
            { symbol: 'BANKIETF.NS', name: 'ICICI Prudential Nifty Bank ETF' },
            { symbol: 'VAL30IETF.NS', name: 'ICICI Prudential Nifty200 Value 30 ETF' },
            { symbol: 'GOLDETFADD.NS', name: 'DSP Gold ETF' },
            { symbol: 'HDFCGROWTH.NS', name: 'HDFC NIFTY Growth Sectors 15 ETF' },
            { symbol: 'MIDCAPIETF.NS', name: 'ICICI Prudential Nifty Midcap 150 ETF' },
            { symbol: 'JUNIORBEES.NS', name: 'Nippon India ETF Nifty Next 50 Junior BeES' },
            { symbol: 'HDFCNEXT50.NS', name: 'HDFC Nifty Next 50 ETF' },
            { symbol: 'MOLOWVOL.NS', name: 'Motilal Oswal S&P BSE Low Volatility ETF' },
            { symbol: 'TOP15IETF.NS', name: 'ICICI Prudential Nifty Top 15 Equal Weight ETF' },
            { symbol: 'SNXT50BEES.NS', name: 'Nippon India ETF S&P BSE Sensex Next 50' },
            { symbol: 'CONSUMER.NS', name: 'Mirae Asset Nifty India New Age Consumption ETF' },
            { symbol: 'SENSEXETF.NS', name: 'Mirae Asset S&P BSE Sensex ETF' },
            { symbol: 'MOHEALTH.NS', name: 'Motilal Oswal S&P BSE Healthcare ETF' },
            { symbol: 'SNXT30BEES.NS', name: 'Nippon India BSE Sensex Next 30 ETF' },
            { symbol: 'NEXT50.NS', name: 'Mirae Asset Nifty Next 50 ETF' },
            { symbol: 'MOM30IETF.NS', name: 'ICICI Prudential Nifty 200 Momentum 30 ETF' },
            { symbol: 'MON100.NS', name: 'Motilal Oswal NASDAQ 100 ETF' },
            { symbol: 'SETFSN50.NS', name: 'SBI ETF SENSEX Next 50' },
            { symbol: 'PSUBNKBEES.NS', name: 'Nippon India ETF Nifty PSU Bank BeES' },
            { symbol: 'BBNPNBETF.NS', name: 'Baroda BNP Paribas Nifty Bank ETF' },
            { symbol: 'TOP10ADD.NS', name: 'DSP Nifty Top 10 Equal Weight ETF' },
            { symbol: 'EQUAL50ADD.NS', name: 'DSP Nifty 50 Equal Weight ETF' },
            { symbol: 'MONQ50.NS', name: 'Motilal Oswal Nasdaq Q 50 ETF' },
            { symbol: 'MIDCAPETF.NS', name: 'Mirae Asset Nifty Midcap 150 ETF' },
            { symbol: 'FMCGIETF.NS', name: 'ICICI Prudential Nifty FMCG ETF' },
            { symbol: 'GOLDIETF.NS', name: 'ICICI Prudential Gold ETF' },
            { symbol: 'PSUBANKADD.NS', name: 'DSP Nifty PSU Bank ETF' },
            { symbol: 'ITETF.NS', name: 'Mirae Asset Nifty IT ETF' },
            { symbol: 'AXSENSEX.NS', name: 'AXIS S&P BSE SENSEX ETF' },
            { symbol: 'SMALLCAP.NS', name: 'Mirae Asset Nifty Smallcap 250 ETF' },
            { symbol: 'HDFCVALUE.NS', name: 'HDFC NIFTY50 Value 20 ETF' },
            { symbol: 'GOLDBEES.NS', name: 'Nippon India ETF Gold BeES' },
            { symbol: 'HEALTHY.NS', name: 'Aditya Birla Sun Life Nifty Healthcare ETF' },
            { symbol: 'ICICIB22.NS', name: 'BHARAT 22 ETF' },
            { symbol: 'HDFCBSE500.NS', name: 'HDFC S&P BSE 500 ETF' },
            { symbol: 'INFRABEES.NS', name: 'Nippon India ETF Nifty Infrastructure BeES' },
            { symbol: 'NIF100IETF.NS', name: 'ICICI Prudential Nifty 100 ETF' },
            { symbol: 'MOQUALITY.NS', name: 'Motilal Oswal S&P BSE Quality ETF' },
            { symbol: 'LOWVOLIETF.NS', name: 'ICICI Prudential Nifty 100 Low Volatility 30 ETF' },
            { symbol: 'GOLD360.NS', name: '360 ONE Gold ETF' },
            { symbol: 'TECH.NS', name: 'Aditya Birla Sun Life Nifty IT ETF' },
            { symbol: 'SETFNIFBK.NS', name: 'SBI ETF Nifty Bank' },
            { symbol: 'LIQUIDBETF.NS', name: 'Bajaj Finserv Nifty 1D Rate Liquid ETF' },
            { symbol: 'EBBETF0430.NS', name: 'Bharat Bond ETF - April 2030' },
            { symbol: 'NV20IETF.NS', name: 'ICICI Prudential Nifty50 Value 20 ETF' },
            { symbol: 'MULTICAP.NS', name: 'Mirae Asset Nifty500 Multicap ETF' },
            { symbol: 'LICNFNHGP.NS', name: 'LIC MF Nifty 100 ETF' },
            { symbol: 'ITETFADD.NS', name: 'DSP Nifty IT ETF' },
            { symbol: 'HDFCNIFTY.NS', name: 'HDFC Nifty 50 ETF' },
            { symbol: 'ESG.NS', name: 'Mirae Asset Nifty 100 ESG Sector Leaders ETF' },
            { symbol: 'SILVER.NS', name: 'Aditya Birla Sun Life Silver ETF' },
            { symbol: 'LOWVOL.NS', name: 'Mirae Asset Nifty 100 Low Volatility 30 ETF' },
            { symbol: 'MASPTOP50.NS', name: 'Mirae Asset S&P 500 Top 50 ETF' },
            { symbol: 'SILVERADD.NS', name: 'DSP Silver ETF' },
            { symbol: 'TATAGOLD.NS', name: 'Tata Gold ETF' },
            { symbol: 'HEALTHIETF.NS', name: 'ICICI Prudential Nifty Healthcare ETF' },
            { symbol: 'NIFTYETF.NS', name: 'Mirae Asset Nifty 50 ETF' },
            { symbol: 'HDFCSENSEX.NS', name: 'HDFC S&P BSE Sensex ETF' },
            { symbol: 'NEXT30ADD.NS', name: 'DSP BSE Sensex Next 30 ETF' },
            { symbol: 'HDFCMID150.NS', name: 'HDFC Nifty Midcap 150 ETF' },
            { symbol: 'GOLDETF.NS', name: 'Mirae Asset Gold ETF' },
            { symbol: 'QUALITY30.NS', name: 'Kotak Nifty200 Quality 30 ETF' },
            { symbol: 'SENSEXIETF.NS', name: 'ICICI Prudential BSE Sensex ETF' },
            { symbol: 'HNGSNGBEES.NS', name: 'Nippon India ETF Hang Seng BeES' },
            { symbol: 'NIF100BEES.NS', name: 'Nippon India ETF Nifty100' },
            { symbol: 'MOMENTUM50.NS', name: 'Motilal Oswal Nifty 500 Momentum 50 ETF' },
            { symbol: 'MOALPHA50.NS', name: 'Motilal Oswal Nifty Alpha 50 ETF' },
            { symbol: 'BSE500IETF.NS', name: 'ICICI Prudential BSE 500 ETF' },
            { symbol: 'SETFNIF50.NS', name: 'SBI ETF Nifty 50' },
            { symbol: 'SETFNN50.NS', name: 'SBI ETF Nifty Next 50' },
            { symbol: 'MONEXT50.NS', name: 'Motilal Oswal Nifty Next 50 ETF' },
            { symbol: 'GROWWNXT50.NS', name: 'Groww Nifty Next 50 ETF' },
            { symbol: 'MOM100.NS', name: 'Motilal Oswal Midcap 100 ETF' },
            { symbol: 'SILVERAG.NS', name: 'Mirae Asset Silver ETF' },
            { symbol: 'GROWWLIQID.NS', name: 'Groww Nifty 1D Rate Liquid ETF' },
            { symbol: 'GROWWDEFNC.NS', name: 'Groww Nifty India Defence ETF' },
            { symbol: 'GROWWRAIL.NS', name: 'Groww Nifty India Railways PSU ETF' },
            { symbol: 'MON50EQUAL.NS', name: 'Motilal Oswal Nifty 50 Equal Weight ETF' },
            { symbol: 'MOMIDMTM.NS', name: 'Motilal Oswal Nifty Midcap150 Momentum 50 ETF' },
            { symbol: 'EMULTIMQ.NS', name: 'Edelweiss Nifty500 Multicap Momentum Quality 50 ETF' },
            { symbol: 'CONSUMBEES.NS', name: 'Nippon India ETF Nifty India Consumption' },
            { symbol: 'MONIFTY500.NS', name: 'Motilal Oswal Nifty 500 ETF' },
            { symbol: 'MOPSE.NS', name: 'Motilal Oswal Nifty PSE ETF' },
            { symbol: 'MOREALTY.NS', name: 'Motilal Oswal Nifty Realty ETF' },
            { symbol: 'MOMGF.NS', name: 'Motilal Oswal Nifty India Manufacturing ETF' },
            { symbol: 'MOSMALL250.NS', name: 'Motilal Oswal Nifty Smallcap 250 ETF' },
            { symbol: 'IVZINNIFTY.NS', name: 'Invesco India Nifty ETF' },
            { symbol: 'SETFBSE100.NS', name: 'SBI ETF BSE 100' },
            { symbol: 'AXISNIFTY.NS', name: 'Axis NIFTY 50 ETF' },
            { symbol: 'TVSINVIT.NS', name: 'TVS Infrastructure Trust Units' }
        ];
        let selectedIndex = -1;
        let filteredStocks = [];
        const symbolInput = document.getElementById('symbol');
        const autocompleteDiv = document.getElementById('autocomplete');

        // --- Autocomplete Stubs ---
        symbolInput.addEventListener('input', function(e) {
            const query = e.target.value.trim().toUpperCase();
            if (query.length === 0) { hideAutocomplete(); return; }
            filteredStocks = stockDatabase.filter(stock =>
                stock.symbol.toUpperCase().includes(query) || stock.name.toUpperCase().includes(query)
            ).slice(0, 8);
            if (filteredStocks.length > 0) { showAutocomplete(filteredStocks); } else { hideAutocomplete(); }
        });
        symbolInput.addEventListener('keydown', function(e) {
            const items = autocompleteDiv.querySelectorAll('.autocomplete-item');
            if (e.key === 'ArrowDown') { e.preventDefault(); selectedIndex = Math.min(selectedIndex + 1, items.length - 1); updateSelection(items); }
            else if (e.key === 'ArrowUp') { e.preventDefault(); selectedIndex = Math.max(selectedIndex - 1, -1); updateSelection(items); }
            else if (e.key === 'Enter' && selectedIndex >= 0) { e.preventDefault(); items[selectedIndex].click(); }
            else if (e.key === 'Escape') { hideAutocomplete(); }
        });
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.input-wrapper')) { hideAutocomplete(); }
        });

        function showAutocomplete(stocks) {
            selectedIndex = -1;
            autocompleteDiv.innerHTML = stocks.map((stock) => `
                <div class="autocomplete-item" onclick="selectStock('${stock.symbol}')">
                    <div class="ticker-symbol">${stock.symbol}</div>
                    <div class="company-name">${stock.name}</div>
                </div>
            `).join('');
            autocompleteDiv.classList.add('active');
        }
        function hideAutocomplete() { autocompleteDiv.classList.remove('active'); selectedIndex = -1; }
        function updateSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedIndex) { item.classList.add('selected'); item.scrollIntoView({ block: 'nearest' }); }
                else { item.classList.remove('selected'); }
            });
            if (selectedIndex >= 0) { symbolInput.value = items[selectedIndex].querySelector('.ticker-symbol').textContent; }
        }
        function selectStock(symbol) { symbolInput.value = symbol; hideAutocomplete(); symbolInput.focus(); }
        // --- End Autocomplete Stubs ---


        // --- Data Fetching Logic (Connects to Flask Backend) ---

        async function fetchData(event) {
            event.preventDefault();

            const symbol = symbolInput.value.toUpperCase();
            const outputDiv = document.getElementById('output');
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const searchBtn = document.getElementById('searchBtn');

            outputDiv.innerHTML = '';
            errorDiv.style.display = 'none';
            loadingDiv.style.display = 'block';
            searchBtn.disabled = true;
            searchBtn.textContent = 'Loading...';
            hideAutocomplete();

            try {
                // IMPORTANT: Ensure your Flask server is running on http://127.0.0.1:5000/
                const response = await fetch('https://stock-dashboard-fqtn.onrender.com', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symbol: symbol }),
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `Server responded with status ${response.status}`);
                }

                displayData(result);
            } catch (error) {
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.style.display = 'block';
            } finally {
                loadingDiv.style.display = 'none';
                searchBtn.disabled = false;
                searchBtn.textContent = 'Get Data';
            }
        }

        // --- Data Display Logic (Updated) ---

        function displayData(data) {
            const outputDiv = document.getElementById('output');

            const companyInfo = stockDatabase.find(s => s.symbol === data.ticker) || { name: 'Technical Analysis Data' };
            const companyName = companyInfo.name;

            // 1. Current Ticker Display
            outputDiv.innerHTML = `
                <div class="ticker-display">
                    <div class="ticker-symbol-main">${data.ticker}</div>
                    <div class="ticker-name-main">${companyName}</div>
                </div>
            `;

            const grid = document.createElement('div');
            grid.className = 'data-grid';

            // 2. OHLCV Card (Full-width, independent toggle)
            const ohlcvCard = createDataCard({
                id: 'ohlcv-card',
                title: 'Candlestick Data (OHLCV)',
                icon: 'ðŸ“ˆ',
                contentHtml: createOhlcvTable(data.OHLCV),
                isOpen: false
            });
            ohlcvCard.classList.add('full-width');
            ohlcvCard.querySelector('.card-header').addEventListener('click', () => toggleCard(ohlcvCard));


            // 3. MA & RSI Card (Full-width, independent toggle)
            const maRsiCard = createDataCard({
                id: 'ma-rsi-card',
                title: 'Moving Averages & RSI',
                icon: 'ðŸ“Š',
                contentHtml: createMaRsiContent(data.MA, data.RSI),
                isOpen: false
            });
            maRsiCard.classList.add('full-width');
            maRsiCard.querySelector('.card-header').addEventListener('click', () => toggleCard(maRsiCard));


            grid.appendChild(ohlcvCard);
            grid.appendChild(maRsiCard);

            // 4. MACD & Signal (Full Width, independent toggle)
            const macdCard = createDataCard({
                title: 'MACD, Signal & Histogram',
                icon: 'ðŸŽ¯',
                contentHtml: createMacdTable(data.MACD),
                isOpen: false
            });
            macdCard.classList.add('full-width');
            macdCard.querySelector('.card-header').addEventListener('click', () => toggleCard(macdCard));
            grid.appendChild(macdCard);

            // 5. AI Review (Full Width, independent toggle)
            const aiReviewCard = createDataCard({
                title: 'AI Review & Summary',
                icon: 'ðŸ¤–',
                contentHtml: createAiReviewContent(data.AI_Review),
                isOpen: false
            });
            aiReviewCard.classList.add('full-width');
            aiReviewCard.querySelector('.card-header').addEventListener('click', () => toggleCard(aiReviewCard));
            grid.appendChild(aiReviewCard);

            outputDiv.appendChild(grid);
        }

        // --- Card Creation and Toggle Functions ---

        // Helper function to create the card HTML structure
        function createDataCard({ id, title, icon, contentHtml, isOpen = false }) {
            const card = document.createElement('div');
            card.className = 'data-card';
            if (id) {
                card.id = id;
            }

            const contentClass = isOpen ? '' : 'collapsed';
            const iconClass = isOpen ? '' : 'collapsed';

            card.innerHTML = `
                <div class="card-header">
                    <h2><span role="img" aria-label="${title} icon">${icon}</span> ${title}</h2>
                    <span class="dropdown-icon ${iconClass}">â–¼</span>
                </div>
                <div class="card-content ${contentClass}">
                    ${contentHtml}
                </div>
            `;
            return card;
        }

        // Standard toggle function for all cards (allows independent open/close)
        function toggleCard(cardElement) {
            const content = cardElement.querySelector('.card-content');
            const icon = cardElement.querySelector('.dropdown-icon');

            const isCurrentlyCollapsed = content.classList.contains('collapsed');

            if (isCurrentlyCollapsed) {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            }
        }

        // --- Content Helper Functions ---

        function createOhlcvTable(data) {
            const limitedData = data.slice(0, 7);
            return `
                <div class="table-scroll-wrapper">
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Open</th>
                                    <th>High</th>
                                    <th>Low</th>
                                    <th>Close</th>
                                    <th>Volume</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${limitedData.map(item => `
                                    <tr>
                                        <td>${item.Date}</td>
                                        <td>${item.Open != null ? '$' + item.Open.toFixed(2) : 'N/A'}</td>
                                        <td>${item.High != null ? '$' + item.High.toFixed(2) : 'N/A'}</td>
                                        <td>${item.Low != null ? '$' + item.Low.toFixed(2) : 'N/A'}</td>
                                        <td>${item.Close != null ? '$' + item.Close.toFixed(2) : 'N/A'}</td>
                                        <td>${item.Volume != null ? item.Volume.toLocaleString() : 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function createMaRsiContent(maData, rsiData) {
            const limitedMaData = maData.slice(0, 7);
            const combinedData = limitedMaData.map((maItem, index) => {
                const rsiValue = rsiData[index];
                return {
                    Date: maItem.Date,
                    MA5: maItem.MA5,
                    MA10: maItem.MA10,
                    RSI: rsiValue
                };
            });

            return `
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>MA5 (Short)</th>
                                <th>MA10 (Long)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${combinedData.map(item => `
                                <tr>
                                    <td>${item.Date}</td>
                                    <td>${item.MA5 != null ? '$' + item.MA5.toFixed(2) : 'N/A'}</td>
                                    <td>${item.MA10 != null ? '$' + item.MA10.toFixed(2) : 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <div style="padding-top: 20px;">
                    <h3 style="color: var(--primary-purple); font-size: 1.1rem; margin-bottom: 10px;">RSI (Latest 7 Days)</h3>
                    <div class="rsi-grid">
                        ${combinedData.map(item => `
                            <div class="rsi-item">
                                <strong>${item.Date.substring(5)}</strong>
                                <span class="rsi-value">${item.RSI != null ? item.RSI.toFixed(2) : 'N/A'}</span>
                            </div>
                        `).join('')}
                    </div>
                    <p style="font-size: 0.9rem; color: #6b7280; margin-top: 15px;">RSI above 70 is considered Overbought, below 30 is Oversold.</p>
                </div>
            `;
        }

        function createMacdTable(data) {
            const limitedData = data.slice(0, 7);
            return `
                <div class="table-scroll-wrapper">
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>MACD Line</th>
                                    <th>Signal Line</th>
                                    <th>Histogram</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${limitedData.map(item => {
                                    const histClass = item.Histogram > 0 ? 'positive-hist' : (item.Histogram < 0 ? 'negative-hist' : '');
                                    return `
                                    <tr>
                                        <td>${item.Date}</td>
                                        <td>${item.MACD != null ? item.MACD.toFixed(3) : 'N/A'}</td>
                                        <td>${item.Signal != null ? item.Signal.toFixed(3) : 'N/A'}</td>
                                        <td class="${histClass}">${item.Histogram != null ? item.Histogram.toFixed(3) : 'N/A'}</td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function createAiReviewContent(reviewText) {
            // Convert markdown text to HTML, specifically handling headers, bold, and paragraphs
            let htmlContent = reviewText;

            // 1. Replace headers (### -> h3)
            htmlContent = htmlContent.replace(/###\s*(.*)/g, '<h3>$1</h3>');

            // 2. Wrap the whole content in a div for styling
            htmlContent = `<div class="ai-review-content">${htmlContent}</div>`;

            // 3. Simple sentiment highlight (find **BULLISH** / **BEARISH** / **NEUTRAL**)
            htmlContent = htmlContent.replace(/\*\*(BULLISH)\*\*/g, '<strong class="sentiment-bullish">BULLISH</strong>');
            htmlContent = htmlContent.replace(/\*\*(BEARISH)\*\*/g, '<strong class="sentiment-bearish">BEARISH</strong>');
            htmlContent = htmlContent.replace(/\*\*(NEUTRAL)\*\*/g, '<strong>NEUTRAL</strong>'); // Keep neutral bold but default color

            // 4. Convert all other **bold** to <strong>
            htmlContent = htmlContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // 5. Convert newline characters to <br> for better text flow in HTML (simple fix)
            htmlContent = htmlContent.replace(/\n/g, '<p>');

            return htmlContent;
        }

        // Initial call to hide error and loading on page load
        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('error').style.display = 'none';
             document.getElementById('loading').style.display = 'none';
        });

    </script>
</body>
</html>